#!/bin/bash

if [ $# != 1 ]; then
    echo "ERROR: missing arguments !"
    echo "USAGE: ./run-all <app-name>"
    exit 1
else
    echo $1
fi

FAULT_APP=$1
#SCENARIO_DIR=${HEMPS_PATH}/testcases/${FAULT_APP}/fault-scenarios/
SCENARIO_DIR=${PWD}

if [ -f ${HEMPS_PATH}/testcases/${FAULT_APP}.hmp ]; then
    echo "Checking hmp file at ${HEMPS_PATH}/testcases/${FAULT_APP}.hmp ... ok !"
else
    echo "ERROR: hmp file not found !"
    echo "USAGE: ./run-all <app.hmp>"
    exit 1
fi
if [ -d "$HEMPS_PATH" ]; then
    echo "Checking HEMPS path at ${HEMPS_PATH} ... ok !"
else
    echo "ERROR: HEMPS_PATH environment variable not found !"
    exit 1
fi
if [ -d ${SCENARIO_DIR} ]; then
    echo "Checking scenario dir at ${SCENARIO_DIR} ... ok !"
else
    echo "ERROR: scenario dir not found !"
    echo "USAGE: ./run-all <app.hmp>"
    exit 1
fi

# list the scenario files and ignore the directories
cd $SCENARIO_DIR
SCENARIOS=`ls  -p | grep -v / | grep scenario`
NSCENARIOS=`ls  -p | grep -v / | grep scenario | wc -l`

#echo $SCENARIOS
echo Executing $FAULT_APP with ${NSCENARIOS} scenarios in `/bin/hostname` at `/bin/date` >> sent_jobs.txt
echo ========================================================================== >> sent_jobs.txt
echo Executing $FAULT_APP with ${NSCENARIOS} scenarios 
echo Submitting jobs ...

for i in $SCENARIOS; do
    if [ ! -d "${i}-log" ]; then
        echo "submitting ${i}"
        echo "qsub -N  fault-${scenarionbr} -cwd ~/hempscrc/scripts/fault/grid.sh ${FAULT_APP} ${i}"
        scenarionbr=$(echo $i|cut -d '-' -f2)
        qsub -N  fault-${scenarionbr} -cwd ~/hempscrc/scripts/fault/grid.sh ${FAULT_APP} ${i}
        # sleep 0.5
    fi
    # if [ $scenarionbr -eq 1006 ]; then
    #     break
    # fi
done
echo Jobs submitted !!!
